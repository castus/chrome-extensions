<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Auto translate plugin for Google Chrome</title>
    <script type="text/javascript" src="http://www.google.com/jsapi"></script>
    <script type="text/javascript">
        google.load("language", "1");
    </script>
    <script type="text/javascript">

        chrome.tabs.onUpdated.addListener(function(tabId, changeInfo, tab) {
            //console.log(changeInfo);
            var scheme = tab.url.substring(0, 5);
            if(scheme == 'https' || scheme == 'http:') {
                chrome.tabs.executeScript(tabId, {file: 'script.js', allFrames: true});
            }
        });

        function clone(obj) {
            var ret = {};
            for (p in obj) {
                ret[p] = ((typeof obj[p] == 'object') ? clone(obj[p]) : obj[p]);
            }
            return ret;
        }
        var defaults = {
            from: {
                'type': 'lang',
                'value': 'auto',
                'values': clone(google.language.Languages)
            },
            first: {
                'type': 'lang',
                'value': 'ru',
                'values': clone(google.language.Languages)
            },
            second: {
                'type': 'lang',
                'value': 'en',
                'values': clone(google.language.Languages)
            },
            detection: {
                'type': 'checkbox',
                'value': true,
            },
            lowercase: {
                'type': 'checkbox',
                'value': true,
            }
        };

        if(!localStorage.options) {
            var hotkeys = {
                'Ctrl+Selection': clone(defaults),
                'Ctrl+Alt+Selection': clone(defaults)
            };
            hotkeys['Ctrl+Selection'].from.value = 'en';
            hotkeys['Ctrl+Alt+Selection'].detection.value = false;
            hotkeys['Ctrl+Alt+Selection'].lowercase.value = false;
            localStorage['options'] = JSON.stringify({hotkeys: hotkeys});
            localStorage['defaults'] = JSON.stringify(defaults);
        }

        var ports = [];

        chrome.extension.onConnect.addListener(function(port) {
            ports[port.portId_] = port;
            port.onMessage.addListener(function(m) {
                switch(m.message) {
                    case 'translate': 
                        var options = JSON.parse(localStorage['options']);
                        if(options['hotkeys'][m.hotkeys]) {
                            translate(m.text, port.portId_, options['hotkeys'][m.hotkeys]);
                        }
                        break;
                    case 'options':
                        port.postMessage({
                            message: 'options',
                            options: JSON.parse(localStorage.options)
                        });
                        break;
                }
            });
        });

        function _translate(text, from, to, options, callback) {
            var url = 'http://translate.google.com/translate_a/t?client=t&otf=1&pc=0';
            url += '&text=' + text;
            url += '&hl=' + options.first.value;
            if(from != 'auto') {
                url += '&sl=' + from;
            }
            url += '&tl=' + to;
            var xhr = new XMLHttpRequest();
            xhr.open("GET", url, true);
            xhr.onreadystatechange = function() {
                if (xhr.readyState == 4) {
                    // JSON.parse does not evaluate the attacker's scripts.
                    callback(JSON.parse(xhr.responseText));
                }
            }
            xhr.send();
        }

        function translate(text, id, options) {
            if(options.lowercase.value) {
                text = text.toLowerCase();
            }

            function translate(text, from) {
                var to = options.first.value;
                if(from == to) {
                    to = options.second.value;
                }
                _translate(text, from, to, options, function(result) {
                    if (result.sentences.length > 0) {
                        if(options.detection.value && 
                           result.sentences[0].trans.toLowerCase() == result.sentences[0].orig.toLowerCase() && 
                           to != options.second.value && to == options.first.value) {
                            return translate(result.sentences[0].orig, options.first.value);
                        }
                        var text = result.sentences[0].trans;
                        var textAdditional = null;
                        if(result.dict && result.dict.length > 0) {
                            text += '<br />';
                            textAdditional = '';
                            for(dict in result.dict) {
                                if(result.dict[dict].pos.length > 0) {
                                    textAdditional += '<b>' + result.dict[dict].pos + '</b> ';
                                }
                                textAdditional += '<i>' + result.dict[dict].terms.join(', ') + '</i><br />';
                            }
                        }
                        ports[id].postMessage({
                            message: 'result',
                            result: {
                                text: text,
                                textAdditional: textAdditional
                            }
                        });
                    }
                });
            }
            
            /*if(options.from == 'auto') {
                google.language.detect(text, function(result) {
                    if(!result.error && result.language) {
                        translate(text, result.language);
                    }
                });
            } else {*/
                translate(text, options.from.value);
            /*}*/
        }
    </script>
</head>
<body></body>
</html>
